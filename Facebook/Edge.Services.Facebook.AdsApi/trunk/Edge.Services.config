<?xml version="1.0" encoding="utf-8" ?>
<configuration>
	<configSections>
		<section name="edge.services" type="Edge.Core.Configuration.EdgeServicesConfiguration, Edge.Core" />
	</configSections>
	
	<appSettings>
		<add key="Edge.Data.Pipeline.FileManager.RootPath" value="D:\Runtime\Edge\Edge.Data.Pipeline.FileManager"/>
		
		<add key="Edge.Data.Pipeline.FileManager.BufferSize" value="20"/>
		<add key="Edge.Data.Pipeline.Delivery.Db4o.FileName" value="Edge.Deliveries.db4o"/>
		<add key="Edge.Data.Pipeline.Delivery.Db4o.Port" value="2121"/>
		<add key="Edge.Data.Pipeline.Delivery.Db4o.User" value="sa"/>
		<add key="Edge.Data.Pipeline.Delivery.Db4o.Password" value="sa"/>
		<add key="Edge.Data.Objects.Measure.GetMeasures.SP" value="Measure_GetMeasures(@accountID:Int,@channelID:Int,@flags:int,@operator:int"/>
		<add key="Edge.Services.AdMetrics.AdMetricsImportManager.BufferSize" value="10"/>
	</appSettings>

	<connectionStrings>
		<add name="Edge.Data.Pipeline.Delivery.DB" connectionString="Host=localhost; User=sa; Password=sa; Port=2121;"/>
		<add name="Edge.Core.Services.SystemDatabase" connectionString="Data Source=localhost; Database=Edge_System; Integrated Security=SSPI;"/>
		<add name="Edge.Data.Pipeline.Delivery.Sql.DeliveriesDb" connectionString="Data Source=alonya-pc; Database=Deliveries;Integrated Security=false;User ID=sa;PWD=Iuh2sstd"/>
		<add name="Edge.Services.AdMetrics.AdMetricsImportManager.Oltp" connectionString="Data Source=alonya-pc; Database=testdb;Integrated Security=false;User ID=sa;PWD=Iuh2sstd"/>
		
	</connectionStrings>

	<edge.services>
		<Extensions>
			<add key="AutoSegments" value="Edge.Data.Pipeline.Configuration.AutoSegmentDefinitionCollection, Edge.Data.Pipeline"/>
			<add key="OptionDefinitions" value="Edge.Data.Pipeline.Configuration.OptionDefinitionCollection, Edge.Data.Pipeline"/>
		</Extensions>

		<!--<ImportMappings>
			<Map To="Ad.Campaign.Channel.Name" DataField="Channel"/>
			<Map To="Ad.Campaign.Account.Name" DataField="AccountName"/>
			<Map To="Ad.Campaign.Name" DataField="Campaign"/>
			<Map To="Ad.DestinationUrl" DataField="destUrl"/>
			<Map To="Ad.Creatives[]">
				<DataFields>
					<DataField DataField="Desc1"/>
					<DataField DataField="Desc2"/>
				</DataFields>
				<Apply New="TextCreative">
					<To Property="TextType" Value="Body"/>
					<To Property="Text" Value="{Desc1}"/>
					<To Property="Text2" Value="{Desc2}"/>
				</Apply>
			</Map>
			<Map To="Ad.Segments[Segment:AdGroup]" DataField="Adgroup">
				<Apply New="SegmentValue">
					<To Property="Value" Value="{Adgroup}"/>
				</Apply>
			</Map>
			<Map To="Ad.Segments[Segment:Tracker]" DataField="destUrl" Regex="\butm_content=(?{utm_content}\w+)\b">
				<Apply New="SegmentValue">
					<To Property="Value" Value="{utm_content}"/>
				</Apply>
			</Map>

			<Map>
				<DataFields>
					<DataField DataField="DayCode" Regex="(?{y}[0-9]{4})(?{m}[0-9]{2})(?{d}[0-9]{2})"/>
				</DataFields>
				<Apply>
					<To Property="AdMetricsUnit.PeriodStart" Value="{date:{y}-{m}-{d}, boundary: 'lower'}"/>
					<To Property="AdMetricsUnit.PeriodEnd" Value="{date:{y}-{m}-{d}, boundary: 'upper'}"/>
				</Apply>
			</Map>
			<Map To="AdMetricsUnit.TargetsMatches[]" DataField="Keyword">
				<Apply New="KeywordTarget">
					<To Property="Keyword" Value="{Keyword}"/>
				</Apply>
			</Map>
			<Map To="AdMetricsUnit.Measures[Measure:Impressions]" DataField="Imps"/>
			<Map To="AdMetricsUnit.Measures[Measure:Clicks]" DataField="Clicks"/>
			<Map To="AdMetricsUnit.Measures[Measure:Cost]" DataField="Cost"/>
		</ImportMappings>-->
		
		<Services>
			<Service
					Name="Facebook.AdsApi"
					Class="Edge.Data.Pipeline.Services.PipelineWorkflowService,Edge.Data.Pipeline"					
					Facebook.BaseServiceAdress="http://api.facebook.com/restserver.php"
					Facebook.Account.Name="PC Speed"
					Facebook.Account.ID="351560853"
					Facebook.Auth.SessionKey="3865f96f5f3aae1cbcf90a8d-100001864609198"
					Facebook.Auth.ApiKey="efddc324f4582ec2e860ba0b6d51d8cb"
					Facebook.Auth.AppSecret="8b9b22d79c6dcd1c6524f73962f2a935"
					Facebook.Auth.SessionSecret="ee767cd8df65047f73f2eb3cf08b1dde"
					Facebook.Ads.XPath.GetAdGroups="ads_getAdGroups_response/ads_adgroup"
					Facebook.Ads.XPath.GetCampaigns="ads_getCampaigns_response/ads_campaign"
					Facebook.Ads.XPath.GetAdGroupStats="ads_getAdGroupStats_response/ads_period_stats/stats/ads_stats"
					Facebook.Ads.XPath.GetAdGroupTargeting="ads_getAdGroupTargeting_response/ads_targeting"
					Facebook.Ads.XPath.GetAdGroupCreatives="ads_getAdGroupCreatives_response/ads_creative"
					SQL.PrepareCommand="SP_Delivery_Commit_Facebook(@DeliveryID:NvarChar,@DeliveryTablePrefix:NvarChar,@MeasuresNamesSQL:NvarChar,@MeasuresFieldNamesSQL:NvarChar,?CommitTableName:NvarChar)"
					SQL.RollbackCommand="SP_Delivery_Rollback_By_DeliveryID(@DeliveryID:NvarChar,@TableName:NvarChar)"
					SQL.CommitCommand="SP_Delivery_Insert_Facebook(@DeliveryFileName:NvarChar,@CommitTableName:NvarChar,@MeasuresNamesSQL:NvarChar,@MeasuresFieldNamesSQL:NvarChar)"
					>

				<OptionDefinitions>
					<Option Name="DeliveryID"/>
				</OptionDefinitions>
				<Workflow>
					<Step Base="InitializerService" IsEnabled="false"  />
					<Step Base="RetriverService" IsEnabled="false" />
					<Step Base="ProcessorService" IsEnabled="false" />
					<Step Base="CommitService"/>
				</Workflow>
				<!--<SchedulingRules>
					<Rule ExactTimes="09:00" CalendarUnit="Day" MaxDeviation="1:10" NextDay="True"/>
				</SchedulingRules>-->
			</Service>
			<Service Name="InitializerService" IsPublic="false" Class="Edge.Services.Facebook.AdsApi.InitializerService,Edge.Services.Facebook.AdsApi" ConflictBehavior="Ignore"/>
			<Service Name="RetriverService" IsPublic="false" Class="Edge.Services.Facebook.AdsApi.RetrieverService,Edge.Services.Facebook.AdsApi"/>
			<Service Name="ProcessorService" IsPublic="false" Class="Edge.Services.Facebook.AdsApi.ProcessorService,Edge.Services.Facebook.AdsApi" AutoAdGroupSegment="true" AdGroupDelimiter=" @ "/>
			<Service Name="CommitService" IsPublic="false" Class="Edge.Services.AdMetrics.AdMetricsCommitService,Edge.Data.Pipeline"/>

			<Service Name="RerunService" AccountID="1007" IsPublic="false">
				<Workflow>
					<Step Base="RerunService"  IsEnabled="true" />
				</Workflow>
			</Service>
			<Service Name="RerunService" IsPublic="false" Class="Edge.Data.Pipeline.Services.RerunService,Edge.Data.Pipeline" ServiceToRun="Facebook.AdsApi"/>
			
		</Services>
		<Accounts>
			<Account ID="1007" Name="PC Speed" >
				<AutoSegments>
					<Segment Name="Tracker" SegmentID="-977">
						<Pattern Regex="\butm_content=(?{utm_content}\w+)\b" Value="{utm_content}"/>
					</Segment>					
				</AutoSegments>
				<Services>
					<Service Uses="Facebook.AdsApi"/>
					<Service Uses="RerunService" ServiceToRun="Facebook.AdsApi"  TargetPeriod="{start: '2011-06-01 00:00:00', end: '2011-06-22 23:59:59'}"/>
				</Services>
			</Account>
		</Accounts>
	</edge.services>
	
</configuration>